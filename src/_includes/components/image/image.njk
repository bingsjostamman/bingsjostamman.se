{% macro cloudinaryPicture(id, alt=null, options={}) %}
  {# Base configuration #}
  {% set baseUrl = "https://res.cloudinary.com/bingsjostamman/image/upload/" %}
  {% set widths = options.widths or [320, 480, 768, 1024, 1280] %}
  {% set sizes = options.sizes or "100vw" %}
  {% set aspect = options.aspect %}
  {% set mobileId = options.mobileId or null %}
  {% set lqipId = options.lqipId or null %}
  {% set fallbackWidth = widths[widths | length - 1] %}

  {# Calculate fallbackHeight if aspect is provided #}
  {% if aspect %}
    {% set parts = aspect | split(":") %}
    {% set widthPart = parts[0] | int %}
    {% set heightPart = parts[1] | int %}
    {% set fallbackHeight = (fallbackWidth / widthPart) * heightPart %}
  {% else %}
    {% set fallbackHeight = null %}
  {% endif %}

  {# Build srcset for main image #}
  {% set srcsetList = "" %}
  {% for w in widths %}
    {% set src = baseUrl ~ "f_auto,q_auto,w_" ~ w ~ "/" ~ id ~ ".jpg" %}
    {% if not loop.first %}
      {% set srcsetList = srcsetList ~ ", " %}
    {% endif %}
    {% set srcsetList = srcsetList ~ src ~ " " ~ w ~ "w" %}
  {% endfor %}

  {# Build srcset for mobile image if provided #}
  {% if mobileId %}
    {% set mobileSrcsetList = "" %}
    {% for w in widths %}
      {% set src = baseUrl ~ "f_auto,q_auto,w_" ~ w ~ "/" ~ mobileId ~ ".jpg" %}
      {% if not loop.first %}
        {% set mobileSrcsetList = mobileSrcsetList ~ ", " %}
      {% endif %}
      {% set mobileSrcsetList = mobileSrcsetList ~ src ~ " " ~ w ~ "w" %}
    {% endfor %}
  {% endif %}

  {# LQIP source #}
  {% if lqipId %}
    {% set lqipSrc = baseUrl ~ "w_20,q_1,e_blur:2000/" ~ lqipId ~ ".jpg" %}
  {% endif %}

  {# Render output #}
  {% if mobileId %}
    <picture>
      <source srcset="{{ mobileSrcsetList }}" media="(max-width: 600px)">
      <img
        src="{{ baseUrl ~ 'w_' ~ fallbackWidth ~ '/' ~ id ~ '.jpg' }}"
        srcset="{{ srcsetList }}"
        sizes="{{ sizes }}"
        alt="{{ alt or '' }}"
        width="{{ fallbackWidth }}"
        {% if fallbackHeight %}height="{{ fallbackHeight }}"{% endif %}
        {% if lqipId %}style="background: url('{{ lqipSrc }}') center/cover no-repeat;"{% endif %}
        loading="{{ options.loading or 'lazy' }}"
        decoding="{{ options.decoding or 'async' }}"
      >
    </picture>
  {% else %}
    <img
      src="{{ baseUrl ~ 'w_' ~ fallbackWidth ~ '/' ~ id ~ '.jpg' }}"
      srcset="{{ srcsetList }}"
      sizes="{{ sizes }}"
      alt="{{ alt or '' }}"
      width="{{ fallbackWidth }}"
      {% if fallbackHeight %}height="{{ fallbackHeight }}"{% endif %}
      {% if lqipId %}style="background: url('{{ lqipSrc }}') center/cover no-repeat;"{% endif %}
      loading="{{ options.loading or 'lazy' }}"
      decoding="{{ options.decoding or 'async' }}"
    >
  {% endif %}
{% endmacro %}